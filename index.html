<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>切片停机监控</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 标题 -->
    <div style="text-align: center; margin: 20px 0;">
        <h1 style="font-family: 'calibri', 'kaiti'; font-size: 32px; margin: 0;">切片停机监控</h1>
    </div>
    
    <!-- 消息显示 -->
    <div style="text-align:center; margin: 10px 0;">
        <span>-</span><span style="font-family: 'calibri', 'kaiti';" id="msgbox"></span><span>-</span>
    </div>
    
    <div style="margin: 20px 0;">        
        <!-- 时间段选择区域 - 居中显示 -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <label for="startDateTime">开始日期：</label>
                <input type="datetime-local" id="startDateTime" style="padding: 5px; font-size: 14px;">
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <label for="endDateTime">结束日期：</label>
                <input type="datetime-local" id="endDateTime" style="padding: 5px; font-size: 14px;">
            </div>
            <button id="queryBtn" style="padding: 6px 15px; font-size: 14px; background-color: #0078D4; color: white; border: none; border-radius: 3px; cursor: pointer;">查询</button>
        </div>
        
        <!-- 快速选择按钮 - 居中显示 -->
        <style>
            /* 添加内联样式，确保按钮样式能够正确显示 */
            .quickSelectBtn {
                padding: 6px 15px !important;
                font-size: 14px !important;
                background-color: #f0f0f0 !important;
                border: 1px solid #ccc !important;
                border-radius: 3px !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
            }
            
            .quickSelectBtn.active {
                background-color: #0078D4 !important;
                color: white !important;
                border-color: #0078D4 !important;
            }
        </style>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
            <button class="quickSelectBtn" data-hours="1">最近1小时</button>
            <button class="quickSelectBtn" data-hours="6">最近6小时</button>
            <button class="quickSelectBtn" data-hours="12">最近12小时</button>
            <button class="quickSelectBtn active" data-hours="24">最近24小时</button>
            <button class="quickSelectBtn" data-days="7">最近7天</button>
            
            <!-- 自动刷新开关 -->
            <label class="switch" style="margin-left: 20px; display: flex; align-items: center; gap: 5px;">
                <input id="isAuto" type="checkbox" checked />
                <span class="slider"></span>
                <span style="margin-left: 10px;">自动刷新</span>
            </label>
        </div>
    </div>
    
    <!-- 图表容器 -->
    <div style="height: 600px; width: 100%;">
        <canvas id="myChart"></canvas>
    </div>
    
    <!-- 停机时间统计表格 -->
    <div style="margin-top: 30px;">
        <h3 style="text-align: center; margin-bottom: 15px;">停机时间统计</h3>
        <div style="overflow-x: auto;">
            <table id="downtimeTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background-color: #f2f2f2;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">开始时间</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">结束时间</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">停机时间（min）</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- div>
        <input id="numberBox" type="number" inputmode="numeric" pattern="[0-9]*" value="1" />
    </div -->
    <script>
        // 辅助函数：格式化日期时间为ISO格式（用于datetime-local输入框）
        function formatDateTimeForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // 辅助函数：将datetime-local输入框的值转换为时间戳
        function getTimestampFromInput(inputId) {
            const input = document.getElementById(inputId);
            if (!input.value) return null;
            return Math.floor(new Date(input.value).getTime() / 1000);
        }
        
        // 初始化默认时间范围（最近24小时）
        function initDateTimeInputs() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 1);
            
            document.getElementById('startDateTime').value = formatDateTimeForInput(startDate);
            document.getElementById('endDateTime').value = formatDateTimeForInput(endDate);
        }
        
        // 设置时间范围
        function setDateTimeRange(startDate, endDate) {
            document.getElementById('startDateTime').value = formatDateTimeForInput(startDate);
            document.getElementById('endDateTime').value = formatDateTimeForInput(endDate);
            // 直接调用RefreshChart，而不是refreshChartWithCustomRange，避免重置按钮样式
            const start_ts = Math.floor(startDate.getTime() / 1000);
            const end_ts = Math.floor(endDate.getTime() / 1000);
            RefreshChart(start_ts, end_ts);
        }
        
        // 快速选择按钮事件处理
        function handleQuickSelectClick(event) {
            const button = event.target;
            
            console.log('handleQuickSelectClick called');
            console.log('Clicked button:', button.textContent);
            
            // 重置所有按钮样式为非选中状态
            const allQuickBtns = document.querySelectorAll('.quickSelectBtn');
            allQuickBtns.forEach(btn => {
                // 直接修改样式
                btn.style.padding = '6px 15px';
                btn.style.fontSize = '14px';
                btn.style.backgroundColor = '#f0f0f0';
                btn.style.color = '#000000';
                btn.style.border = '1px solid #ccc';
                btn.style.borderRadius = '3px';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'all 0.2s ease';
                btn.classList.remove('active');
                console.log('Reset style for button:', btn.textContent);
            });
            
            // 设置当前按钮样式为选中状态
            // 直接修改样式
            button.style.padding = '6px 15px';
            button.style.fontSize = '14px';
            button.style.backgroundColor = '#0078D4';
            button.style.color = '#ffffff';
            button.style.border = '1px solid #0078D4';
            button.style.borderRadius = '3px';
            button.style.cursor = 'pointer';
            button.style.transition = 'all 0.2s ease';
            button.classList.add('active');
            console.log('Set active style for button:', button.textContent);
            console.log('Button classes:', button.className);
            
            const now = new Date();
            let startDate = new Date();
            
            if (button.dataset.hours) {
                // 按小时选择
                startDate.setHours(startDate.getHours() - parseInt(button.dataset.hours));
            } else if (button.dataset.days) {
                // 按天选择
                startDate.setDate(startDate.getDate() - parseInt(button.dataset.days));
            }
            
            setDateTimeRange(startDate, now);
        }
        
        // 刷新图表（使用自定义时间范围）
        function refreshChartWithCustomRange() {
            // 获取自定义时间范围
            const start_ts = getTimestampFromInput('startDateTime');
            const end_ts = getTimestampFromInput('endDateTime');
            
            if (!start_ts || !end_ts) {
                console.error('Invalid date range');
                return;
            }
            
            // 当使用自定义时间段时，重置所有快速选择按钮样式为非选中状态
            const allQuickBtns = document.querySelectorAll('.quickSelectBtn');
            allQuickBtns.forEach(btn => {
                // 直接修改样式
                btn.style.padding = '6px 15px';
                btn.style.fontSize = '14px';
                btn.style.backgroundColor = '#f0f0f0';
                btn.style.color = '#000000';
                btn.style.border = '1px solid #ccc';
                btn.style.borderRadius = '3px';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'all 0.2s ease';
                btn.classList.remove('active');
                console.log('Reset style for button:', btn.textContent);
            });
            
            // 调用刷新函数，传入自定义时间范围
            RefreshChart(start_ts, end_ts);
        }
        
        // 等待DOM完全加载后添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            // 初始化日期时间输入框
            initDateTimeInputs();
            
            // 添加查询按钮事件监听器
            document.getElementById("queryBtn").addEventListener("click", () => {
                console.log('Query button clicked');
                refreshChartWithCustomRange();
            });
            
            // 添加快速选择按钮事件监听器
            const quickSelectBtns = document.querySelectorAll('.quickSelectBtn');
            console.log('Found quick select buttons:', quickSelectBtns.length);
            quickSelectBtns.forEach(btn => {
                btn.addEventListener('click', handleQuickSelectClick);
                console.log('Added click listener to button:', btn.textContent);
            });
            
            // 设置默认选中按钮（最近24小时）的样式
            const defaultActiveBtn = document.querySelector('.quickSelectBtn.active');
            if (defaultActiveBtn) {
                // 直接修改样式
                defaultActiveBtn.style.padding = '6px 15px';
                defaultActiveBtn.style.fontSize = '14px';
                defaultActiveBtn.style.backgroundColor = '#0078D4';
                defaultActiveBtn.style.color = '#ffffff';
                defaultActiveBtn.style.border = '1px solid #0078D4';
                defaultActiveBtn.style.borderRadius = '3px';
                defaultActiveBtn.style.cursor = 'pointer';
                defaultActiveBtn.style.transition = 'all 0.2s ease';
                console.log('Set default active style for button:', defaultActiveBtn.textContent);
            }
        });
    </script>

    <!-- script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script -->
    <script src="chart.umd.min.js"></script>
    <script>
        Date.prototype.ISOFormat = function () {
            var sDate = this.toISOString().split("T")[0];
            var aTime = this.toISOString().split("T")[1].split(":");
            return sDate + "T" + aTime[0] + ":" + aTime[1] + "Z";
        }

        var MATXT = [];

        const header = (tooltipItems) => {
            /*
            let sum = 0;
            tooltipItems.forEach(function (tooltipItem) {
                // sum += tooltipItem.parsed.y;
            });
            */
            if (MATXT[tooltipItems[0].dataIndex]) {
                return '生产香型: ' + MATXT[tooltipItems[0].dataIndex];
            }
        };

        const ctx = document.getElementById('myChart');
        // const sheeting_ctx = document.getElementById('sheetingChart');
        
        // 添加默认数据，以便在API请求失败时图表仍然可以显示
        const defaultLabels = ['默认数据1', '默认数据2', '默认数据3', '默认数据4', '默认数据5'];
        const defaultData = [0, 0, 0, 0, 0];
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: defaultLabels,
                datasets: [
                    {
                        label: '切片整线速度',
                        data: defaultData,
                        borderColor: 'rgba(0,158,235,1)',
                        backgroundColor: 'rgba(0,158,235,0.5)',
                        yAxisID: 'y',
                        tension: 0.1 // 添加曲线平滑度
                    },
                    {
                        label: '挤压出口胶温度',
                        data: defaultData,
                        // borderColor: 'rgba(214,66,0,1)',
                        borderColor: 'rgba(227,0,115,1)',
                        backgroundColor: 'rgba(227,0,115,0.5)',
                        yAxisID: 'y1',
                        tension: 0.1 // 添加曲线平滑度
                    },
                    {
                        label: '冷辊入口胶温度',
                        data: defaultData,
                        borderColor: 'rgba(230,160,0,1)',
                        backgroundColor: 'rgba(230,160,0,0.5)',
                        yAxisID: 'y1',
                        tension: 0.1 // 添加曲线平滑度
                    }
                ],

            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // 允许图表调整大小
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        labels: {
                            font: {
                                size: 13,
                                family: "'calibri', 'kaiti'",
                            }
                        }
                    },
                    tooltip: {
                        titleFont: {
                            size: 14,
                            weight: "bold",
                            family: "'calibri', 'kaiti'",
                        },
                        bodyFont: {
                            size: 13,
                            family: "'calibri', 'kaiti'",
                        },
                        callbacks: {
                            afterTitle: (tooltipItems) => {
                                if (MATXT[tooltipItems[0].dataIndex]) {
                                    return MATXT[tooltipItems[0].dataIndex];
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 180,
                        ticks: {
                            beginAtZero: true,
                            stepSize: 10,
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 180,
                        /* grid line settings
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                        */
                        ticks: {
                            beginAtZero: true,
                            stepSize: 10,
                        },
                    },
                },
                elements: {
                    point: {
                        radius: 0, // 不显示数据点
                    },
                    line: {
                        borderWidth: 2 // 线条宽度
                    }
                }
            },
        });

        // 统计停机时间函数
        function calculateDowntime(times, speeds) {
            const downtimeList = [];
            let downtimeStart = null;
            
            // 遍历所有数据点，统计连续为0的时间段
            for (let i = 0; i < speeds.length; i++) {
                if (speeds[i] === 0 && downtimeStart === null) {
                    // 开始停机
                    downtimeStart = times[i];
                } else if (speeds[i] !== 0 && downtimeStart !== null) {
                    // 结束停机
                    const downtimeEnd = times[i];
                    downtimeList.push({
                        start: downtimeStart,
                        end: downtimeEnd
                    });
                    downtimeStart = null;
                }
            }
            
            // 处理最后一个数据点仍然是停机状态的情况
            if (downtimeStart !== null) {
                const downtimeEnd = times[times.length - 1];
                downtimeList.push({
                    start: downtimeStart,
                    end: downtimeEnd
                });
            }
            
            // 更新表格
            updateDowntimeTable(downtimeList);
        }
        
        // 更新停机时间表格
        function updateDowntimeTable(downtimeList) {
            const tableBody = document.querySelector('#downtimeTable tbody');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 如果没有停机数据
            if (downtimeList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            // 添加停机数据行
            downtimeList.forEach(downtime => {
                // 解析日期时间字符串
                const startTime = new Date(downtime.start);
                const endTime = new Date(downtime.end);
                
                // 计算停机持续时间（毫秒）
                const durationMs = endTime - startTime;
                
                // 转换为分钟数（保留一位小数）
                const durationMins = Math.round((durationMs / (1000 * 60)) * 10) / 10;
                
                // 创建表格行
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid #ddd; padding: 8px;">${downtime.start}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${downtime.end}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${durationMins}分钟</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        var RefreshChart = (customStartTs = null, customEndTs = null) => {
            // 检查是否需要跳过刷新（仅在自动刷新模式下）
            if (!document.getElementById("isAuto").checked && !customStartTs && !customEndTs) {
                return;
            }

            MATXT = [];
            var UAUTC = [];
            var SXSRS = [];
            var CEMGT = [];
            var EGRMT = [];

            var dtNow = new Date();
            var end_ts = customEndTs || Math.floor(dtNow.getTime()/1000);
            var start_ts = customStartTs || end_ts - 60*60*24;
            
            console.log('RefreshChart called');
            console.log('Start time:', new Date(start_ts * 1000).toLocaleString());
            console.log('End time:', new Date(end_ts * 1000).toLocaleString());
            
            // 使用代理服务器请求真实API数据，解决CORS问题
            // 优先尝试使用uniCloud云函数（如果可用），否则使用本地代理服务器
            const useUniCloud = false; // 设置为true以使用uniCloud云函数
            
            if (useUniCloud && typeof uni !== 'undefined' && typeof uniCloud !== 'undefined') {
                console.log('Using uniCloud cloud function for API request');
                
                // 使用uniCloud云函数调用
                uniCloud.callFunction({
                    name: 'api-proxy',
                    data: { 
                        start_datetime: start_ts, 
                        end_datetime: end_ts,
                        httpMethod: 'POST'
                    },
                    success: (res) => {
                        console.log('uniCloud function response:', res);
                        const json = res.result.data;
                        processApiResponse(json);
                    },
                    fail: (err) => {
                        console.error('uniCloud function call failed:', err);
                        document.getElementById("msgbox").innerText = 'Error: ' + err.errMsg;
                        updateDowntimeTable([]);
                    }
                });
            } else {
                // 使用Render部署的代理服务器
                // 部署后请将下方URL替换为您的Render服务URL
                const url = `https://your-render-service-url/api/huacore.forms/documentapi/getvalue?t=${new Date().getTime()}`;
                console.log('API URL via Render proxy:', url);
                
                fetch(url, { 
                    method: "POST", 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ "start_datetime": start_ts, "end_datetime": end_ts }) 
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Http error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(json => {
                    processApiResponse(json);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById("msgbox").innerText = 'Error: ' + error.message;
                    updateDowntimeTable([]);
                });
            }
        };
        
        // 处理API响应数据
        function processApiResponse(json) {
            console.log('API response data:', json);
            console.log('Data length:', json.length);
            
            document.getElementById("msgbox").innerText = json.length;
            
            // 如果没有数据，保持当前图表不变
            if (json.length === 0) {
                console.log('No data returned from API');
                // 清空停机表格
                updateDowntimeTable([]);
                return;
            }
            
            json.forEach(element => {
                var dt = new Date(element["UAUTC"]);
                var rs = element["SXSRS"] ? element["SXSRS"] / 1.2 : 0;
                var gt = element["CEMGT"] ? element["CEMGT"] : 0;
                var et = element["EGRMT"] ? element["EGRMT"] : 0;
                if (gt <= 30 || et <= 38) { rs = 0; }
                
                UAUTC.push(dt.toLocaleString());
                SXSRS.push(Number(rs.toFixed(1)));
                CEMGT.push(Number(gt.toFixed(2)));
                EGRMT.push(Number(et.toFixed(2)));
                MATXT.push(element["MATXT"]);
            });
            
            console.log('Processed data:');
            console.log('Labels:', UAUTC);
            console.log('SXSRS data:', SXSRS);
            console.log('EGRMT data:', EGRMT);
            console.log('CEMGT data:', CEMGT);
            
            chart.data.labels = UAUTC;
            chart.data.datasets[0].data = SXSRS;
            chart.data.datasets[1].data = EGRMT;
            chart.data.datasets[2].data = CEMGT;
            chart.update();
            
            // 统计停机时间
            calculateDowntime(UAUTC, SXSRS);
            
            console.log('Chart updated successfully with real API data');
        }
        // Initiate Chart
        RefreshChart();
        //
        setInterval(RefreshChart, 45000)
    </script>
</body>
</html>